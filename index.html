<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Cat√°logo Interactivo con Login/Registro</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
:root{--accent:#007bff;--green-effect:rgba(0,200,0,0.28);}
*{box-sizing:border-box;}
body{margin:0;padding:0;font-family:Arial,sans-serif;}
button{cursor:pointer;}
#login-section{display:flex;justify-content:center;align-items:center;height:100vh;padding:20px;}
#login-box{background:white;padding:25px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,0.12);width:350px;}
#login-box h2{text-align:center;margin-bottom:18px;}
#login-box input{width:100%;margin-bottom:10px;padding:10px;border-radius:6px;border:1px solid #ccc;font-size:15px;}
#login-box button{width:100%;background:var(--accent);color:white;padding:10px;border:none;border-radius:6px;margin-top:6px;}
#login-box button:hover{background:#0056b3;}
#login-box .toggle-login{margin-top:12px;text-align:center;cursor:pointer;color:var(--accent);text-decoration:underline;font-size:14px;}
body.logged #login-section{display:none;}
body.logged #main-section{display:flex;gap:20px;padding:20px;}
#main{flex:3;min-width:0;padding:0 10px;}
#sidebar{flex:1;background:white;padding:15px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.08);position:sticky;top:20px;max-height:90vh;overflow-y:auto;transition:transform 0.3s;}
#busqueda,#categoria-filtro{display:block;margin:10px auto;padding:12px;font-size:16px;border-radius:8px;border:1px solid #ccc;width:92%;max-width:820px;}
#catalogo{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:20px;margin-top:10px;}
.producto{background:white;border-radius:12px;padding:14px;box-shadow:0 4px 10px rgba(0,0,0,0.06);display:flex;flex-direction:column;align-items:center;transition:transform .18s;}
.producto:hover{transform:translateY(-6px);}
.producto img{width:150px;height:150px;object-fit:cover;border-radius:8px;margin-bottom:10px;display:block;}
.producto .info{text-align:center;margin-bottom:10px;}
.acciones{display:flex;gap:8px;align-items:center;}
.producto input[type="number"]{width:64px;padding:6px;text-align:center;border-radius:6px;border:1px solid #ccc;}
.producto button{padding:8px 12px;background:var(--accent);color:#fff;border:none;border-radius:8px;}
.producto button:hover{background:#0056b3;}
#carrito ul{list-style:none;padding:0;margin:0;}
#carrito li{padding:6px 0;border-bottom:1px solid #eee;font-size:14px;}
#total{text-align:right;font-weight:700;margin-top:10px;color:var(--accent);}
#enviar-pedido-btn{display:block;text-align:center;margin-top:12px;background:#16a34a;color:white;padding:12px 10px;border-radius:8px;text-decoration:none;font-weight:700;}
#sidebar input,#sidebar select,#sidebar textarea{width:100%;padding:10px;border-radius:6px;border:1px solid #ccc;font-size:15px;box-sizing:border-box;margin-bottom:10px;}
.fly-wrapper{position:absolute;z-index:9999;width:120px;height:120px;border-radius:50%;display:flex;align-items:center;justify-content:center;overflow:hidden;background:var(--green-effect);
box-shadow:0 8px 20px rgba(0,0,0,0.18);transition:left .95s cubic-bezier(.22,1,.36,1),top .95s cubic-bezier(.22,1,.36,1),
width .95s cubic-bezier(.22,1,.36,1),height .95s cubic-bezier(.22,1,.36,1),opacity .6s ease;pointer-events:none;}
.fly-wrapper img{width:78%;height:auto;border-radius:8px;object-fit:cover;transition:width .95s,height .95s,transform .95s;display:block;}
.envio-info{margin:10px 0;padding:10px;background:#f8f9fa;border-radius:8px;border-left:4px solid var(--accent);}
.envio-info p{margin:5px 0;}
.envio-info .costo{font-weight:bold;color:#16a34a;}
.envio-info .error{color:#dc2626;}
@media(max-width:900px){body.logged #main-section{flex-direction:column;}#main,#sidebar{width:100%;}#sidebar{position:relative;top:auto;max-height:none;overflow:visible;}#busqueda,#categoria-filtro{width:96%;}}
</style>
</head>
<body>

<section id="login-section">
  <div id="login-box">
    <h2 id="login-title">Login</h2>
    <input type="text" id="usuario-input" placeholder="Usuario" required>
    <input type="password" id="password-input" placeholder="Contrase√±a" required>
    <input type="text" id="nombre-input" placeholder="Nombre Completo" style="display:none;" required>
    <input type="text" id="telefono-input" placeholder="Tel√©fono" style="display:none;" required>
    <button id="login-btn">Ingresar</button>
    <div class="toggle-login" id="toggle-login">Crear cuenta</div>
  </div>
</section>

<section id="main-section" style="display:none;">
  <div id="main">
    <div id="logo-empresa" style="text-align:center;margin-bottom:12px;">
      <img src="./PAPELERA shadow.png" alt="logo" style="max-width:220px;width:100%;height:auto;">
    </div>
    <input type="text" id="busqueda" placeholder="Buscar producto...">
    <select id="categoria-filtro"><option value="Todas">Todas las categor√≠as</option></select>
    <div id="catalogo">Cargando productos...</div>
  </div>

  <div id="sidebar">
    <section>
      <h2>Datos de entrega y pago</h2>
      <input type="text" id="direccion-entrega" placeholder="Direcci√≥n de entrega *" required>
      <select id="localidad-entrega">
        <option value="">Seleccione localidad *</option>
        <option value="Tandil">Tandil</option>
        <option value="Azul">Azul</option>
        <option value="Olavarr√≠a">Olavarr√≠a</option>
        <option value="Rauch">Rauch</option>
        <option value="Benito Ju√°rez">Benito Ju√°rez</option>
        <option value="Ayacucho">Ayacucho</option>
        <option value="Balcarce">Balcarce</option>
        <option value="Lober√≠a">Lober√≠a</option>
        <option value="Necochea">Necochea</option>
        <option value="Mar del Plata">Mar del Plata</option>
        <option value="Miramar">Miramar</option>
        <option value="La Plata">La Plata</option>
        <option value="Bah√≠a Blanca">Bah√≠a Blanca</option>
        <option value="Tres Arroyos">Tres Arroyos</option>
        <option value="Coronel Su√°rez">Coronel Su√°rez</option>
        <option value="Tornquist">Tornquist</option>
        <option value="Otra">Otra localidad</option>
      </select>
      <input type="text" id="localidad-otra" placeholder="Especifique su localidad" style="display:none;">
      <input type="text" id="referencia-entrega" placeholder="Referencia (opcional)">
      <select id="metodo-pago">
        <option value="Efectivo">Efectivo</option>
        <option value="Transferencia">Transferencia</option>
        <option value="Debito">D√©bito</option>
      </select>
      <textarea id="observaciones" rows="3" placeholder="Observaciones del pedido"></textarea>
      
      <div id="envio-info" class="envio-info" style="display:none;">
        <p>Informaci√≥n de env√≠o:</p>
        <p id="distancia-envio"></p>
        <p id="costo-envio" class="costo"></p>
      </div>
    </section>

    <h2>üõí Carrito</h2>
    <ul id="carrito"></ul>
    <div id="total">Total: $0</div>
    <a id="enviar-pedido-btn" href="#">Enviar pedido</a>
  </div>
</section>

<script>
// üîê DATOS SENSIBLES - Se llenar√°n autom√°ticamente en Vercel
const SHEET_ID = '1NLPpVF7eNUXYc1xnmLA2ecLWQJL7hSOytdvZktwNIEg';
const URL_SCRIPT_CREAR_USUARIO = 'https://script.google.com/macros/s/AKfycbxhkQrjzmMkNt8y1-7xrg2788quKOOQLRjOL9IIFmhJsjirQRbcoeYMetbvOK95BHhJIg/exec';
const URL_SCRIPT_PEDIDO = 'https://script.google.com/macros/s/AKfycbwy6VcLxNKTMO9ZgAnOWUNfOSm4CFjarJGp9S6HjFgOFphbl9T21y--53hcwcxiDtIWSg/exec';

// URLs que se generan autom√°ticamente
const SHEET_URL = `https://opensheet.elk.sh/${SHEET_ID}/1`;
const SHEET_PRODUCTOS = `https://opensheet.elk.sh/${SHEET_ID}/Productos`;

// API Key de Google Maps
const GOOGLE_MAPS_API_KEY = 'AIzaSyD28MYISEZGkCh1tnTe4NrYC4fpcjnICmA';

// Direcci√≥n del local
const LOCAL_ADDRESS = 'Pasaje Guernica 1615, Tandil, Provincia de Buenos Aires, Argentina';

let productosGlobal=[], carrito=[], usersCache=[], productosPrecios=[];
let telefonoUsuario = ""; // tel√©fono del cliente logueado
let costoEnvio = 0;

const catalogoDiv=document.getElementById('catalogo');
const carritoUl=document.getElementById('carrito');
const categoriaFiltro=document.getElementById('categoria-filtro');
const direccionInput=document.getElementById('direccion-entrega');
const localidadSelect=document.getElementById('localidad-entrega');
const localidadOtraInput=document.getElementById('localidad-otra');
const referenciaInput=document.getElementById('referencia-entrega');
const metodoPagoSelect=document.getElementById('metodo-pago');
const observacionesInput=document.getElementById('observaciones');
const busquedaInput=document.getElementById('busqueda');
const enviarPedidoBtn=document.getElementById('enviar-pedido-btn');
const envioInfoDiv=document.getElementById('envio-info');
const distanciaEnvioP=document.getElementById('distancia-envio');
const costoEnvioP=document.getElementById('costo-envio');

const loginSection=document.getElementById('login-section');
const mainSection=document.getElementById('main-section');
const loginTitle=document.getElementById('login-title');
const toggleLogin=document.getElementById('toggle-login');
const usuarioInput=document.getElementById('usuario-input');
const passwordInput=document.getElementById('password-input');
const nombreInput=document.getElementById('nombre-input');
const telefonoInput=document.getElementById('telefono-input');
const loginBtn=document.getElementById('login-btn');

/* Render cat√°logo SIN precios */
function renderCatalogo(productos){
  catalogoDiv.innerHTML='';
  productos.forEach(p=>{
    const div=document.createElement('div'); div.className='producto';
    div.innerHTML=`<img src="${p.imagen}" alt="${p.nombre}">
    <div class="info"><strong>${p.nombre}</strong><br><small>${p.categoria}</small></div>
    <div class="acciones">
      <input type="number" id="cant-${p.nombre}" value="1" min="1">
      <button>Agregar</button>
    </div>`;
    catalogoDiv.appendChild(div);
    const button = div.querySelector('button');
    button.addEventListener('click',()=>agregarAlCarrito(p, button));
  });
}

/* Render carrito */
function renderCarrito(){
  carritoUl.innerHTML='';
  let total=0;
  carrito.forEach(item=>{
    const prodPrecio = productosPrecios.find(p=>p.nombre===item.nombre);
    const precio = prodPrecio ? parseFloat(prodPrecio.precio) : 0;
    total+=precio*item.cantidad;
    const li=document.createElement('li');
   li.textContent=`${item.nombre} x${item.cantidad}`;
    carritoUl.appendChild(li);
  });
  
  // Actualizar total incluyendo env√≠o
  const totalElement = document.getElementById('total');
  totalElement.textContent = `Total: $${(total + costoEnvio).toFixed(2)}`;
  if (costoEnvio > 0) {
    totalElement.innerHTML += `<br><small>($${total.toFixed(2)} productos + $${costoEnvio.toFixed(2)} env√≠o)</small>`;
  }
}

/* Agregar al carrito + efecto vuelo */
function agregarAlCarrito(producto, button){
  const input=document.getElementById(`cant-${producto.nombre}`);
  const cantidad=parseInt(input.value)||1;
  const existente=carrito.find(p=>p.nombre===producto.nombre);
  if(existente) existente.cantidad+=cantidad;
  else carrito.push({...producto,cantidad});
  renderCarrito();

  const rect = button.getBoundingClientRect();
  const fly=document.createElement('div'); fly.className='fly-wrapper';
  const imgClone=document.createElement('img'); imgClone.src=producto.imagen;
  fly.appendChild(imgClone); document.body.appendChild(fly);

  fly.style.left = (rect.left + window.scrollX) + 'px';
  fly.style.top  = (rect.top + window.scrollY) + 'px';
  fly.style.width = rect.width + 'px';
  fly.style.height = rect.height + 'px';

  setTimeout(()=>{
    const target = carritoUl.getBoundingClientRect();
    fly.style.left = (target.left + window.scrollX) + 'px';
    fly.style.top  = (target.top + window.scrollY) + 'px';
    fly.style.width='30px'; fly.style.height='30px'; fly.style.opacity='0.3';
    imgClone.style.width='30px';
  },50);

  setTimeout(()=>{fly.remove();},900);
}

/* Filtros */
function filtrar(){
  const val=busquedaInput.value.toLowerCase();
  const cat=categoriaFiltro.value.toLowerCase();
  let filtrados=productosGlobal.filter(p=>p.nombre.toLowerCase().includes(val));
  if(cat!=='todas') filtrados=filtrados.filter(p=>p.categoria.toLowerCase()===cat);
  renderCatalogo(filtrados);
}
categoriaFiltro.addEventListener('change',filtrar);
busquedaInput.addEventListener('input',filtrar);

/* Fetch productos */
fetch(SHEET_URL)
.then(r=>r.json())
.then(data=>{
  productosGlobal=data;
  renderCatalogo(productosGlobal);
  [...new Set(productosGlobal.map(p=>p.categoria))].forEach(cat=>{
    const option=document.createElement('option');
    option.value=cat; option.textContent=cat;
    categoriaFiltro.appendChild(option);
  });
});

/* Fetch precios reales desde Productos */
fetch(SHEET_PRODUCTOS)
.then(r=>r.json())
.then(data=>{productosPrecios=data;});

/* Calcular costo de env√≠o usando Google Maps API */
async function calcularCostoEnvio() {
  const direccion = direccionInput.value.trim();
  const localidad = localidadSelect.value === 'Otra' ? localidadOtraInput.value.trim() : localidadSelect.value;
  
  if (!direccion || !localidad) {
    envioInfoDiv.style.display = 'none';
    costoEnvio = 0;
    renderCarrito();
    return;
  }
  
  // Construir direcci√≥n completa para la API
  const direccionCompleta = `${direccion}, ${localidad}, Provincia de Buenos Aires, Argentina`;
  
  // Mostrar loading
  envioInfoDiv.style.display = 'block';
  distanciaEnvioP.textContent = 'Calculando distancia...';
  costoEnvioP.textContent = 'Cargando...';
  
  try {
    // URL corregida para la API de Distance Matrix
    const url = `https://cors-anywhere.herokuapp.com/https://maps.googleapis.com/maps/api/distancematrix/json?origins=${encodeURIComponent(LOCAL_ADDRESS)}&destinations=${encodeURIComponent(direccionCompleta)}&key=${GOOGLE_MAPS_API_KEY}`;
    
    console.log('Consultando API de Google Maps...');
    
    const response = await fetch(url, {
      method: 'GET',
      headers: {
        'Accept': 'application/json',
      }
    });
    
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    const data = await response.json();
    console.log('Respuesta de Google Maps:', data);
    
    if (data.status === 'OK' && data.rows[0].elements[0].status === 'OK') {
      const distancia = data.rows[0].elements[0].distance;
      const distanciaKm = distancia.value / 1000; // Convertir metros a kil√≥metros
      
      // Calcular costo de env√≠o (ejemplo: $100 base + $10 por km)
      costoEnvio = 100 + (distanciaKm * 10);
      
      // Mostrar informaci√≥n de env√≠o
      distanciaEnvioP.textContent = `Distancia: ${distancia.text}`;
      costoEnvioP.textContent = `Costo de env√≠o: $${costoEnvio.toFixed(2)}`;
      costoEnvioP.className = 'costo';
    } else {
      throw new Error(`API Error: ${data.status} - ${data.rows[0].elements[0].status}`);
    }
  } catch (error) {
    console.error('Error al calcular env√≠o:', error);
    distanciaEnvioP.textContent = 'Error: No se pudo conectar con el servicio de mapas';
    costoEnvioP.textContent = 'Costo de env√≠o: $0 (error)';
    costoEnvioP.className = 'error';
    costoEnvio = 0;
  }
  
  renderCarrito();
}

// Event listeners para calcular env√≠o cuando cambian los datos de entrega
direccionInput.addEventListener('blur', calcularCostoEnvio);
localidadSelect.addEventListener('change', function() {
  if (this.value === 'Otra') {
    localidadOtraInput.style.display = 'block';
  } else {
    localidadOtraInput.style.display = 'none';
    calcularCostoEnvio();
  }
});
localidadOtraInput.addEventListener('blur', calcularCostoEnvio);

/* Enviar pedido con precios reales y tel√©fono */
enviarPedidoBtn.addEventListener("click", async e=>{
  e.preventDefault();
  
  // Validar campos requeridos
  if (!direccionInput.value.trim()) {
    alert("Por favor, ingrese una direcci√≥n de entrega");
    direccionInput.focus();
    return;
  }
  
  if (!localidadSelect.value || (localidadSelect.value === 'Otra' && !localidadOtraInput.value.trim())) {
    alert("Por favor, seleccione una localidad");
    localidadSelect.focus();
    return;
  }
  
  if(carrito.length===0){
    alert("El carrito est√° vac√≠o");
    return;
  }

  const productosFormateados = carrito.map(item=>{
    const prodPrecio = productosPrecios.find(p=>p.nombre===item.nombre);
    const precio = prodPrecio ? parseFloat(prodPrecio.precio) : 0;
    return `${item.nombre} x${item.cantidad} ($${precio.toFixed(2)} c/u)`;
  }).join(" | ");

  const totalProductos = carrito.reduce((s,item)=>{
    const prodPrecio = productosPrecios.find(p=>p.nombre===item.nombre);
    const precio = prodPrecio ? parseFloat(prodPrecio.precio) : 0;
    return s + precio*item.cantidad;
  },0);

  const fecha = new Date().toLocaleString('es-AR');
  const localidad = localidadSelect.value === 'Otra' ? localidadOtraInput.value.trim() : localidadSelect.value;

  const params=new URLSearchParams({
    fecha: fecha,
    usuario: usuarioInput.value||"Invitado",
    productos: productosFormateados,
    direccion: direccionInput.value||"Sin direcci√≥n",
    localidad: localidad,
    referencia: referenciaInput.value||"Sin referencia",
    metodoPago: metodoPagoSelect.value,
    observaciones: observacionesInput.value||"Ninguna",
    totalProductos: totalProductos.toFixed(2),
    costoEnvio: costoEnvio.toFixed(2),
    total: (totalProductos + costoEnvio).toFixed(2),
    telefono: telefonoUsuario            // <--- TELEFONO incluido
  });

  const loader = document.createElement('div');
  loader.textContent = 'Enviando pedido...';
  loader.style.position='fixed';
  loader.style.top='50%';
  loader.style.left='50%';
  loader.style.transform='translate(-50%,-50%)';
  loader.style.background='rgba(0,0,0,0.8)';
  loader.style.color='white';
  loader.style.padding='20px';
  loader.style.borderRadius='12px';
  loader.style.zIndex='9999';
  document.body.appendChild(loader);

  fetch(URL_SCRIPT_PEDIDO+"?"+params.toString())
    .then(r=>r.json())
    .then(res=>{
      loader.remove();
      if(res.success){
        alert("‚úÖ Pedido enviado correctamente"); 
        carrito=[]; 
        costoEnvio = 0;
        renderCarrito();
        envioInfoDiv.style.display = 'none';
      }
      else alert("‚ùå Error: "+res.error);
    })
    .catch(err=>{loader.remove(); alert("‚ùå Error de conexi√≥n: "+err);});
});

/* Login / Registro */
toggleLogin.addEventListener('click',()=>{
  if(loginTitle.textContent==='Login'){
    loginTitle.textContent='Registro'; loginBtn.textContent='Crear cuenta';
    nombreInput.style.display='block'; telefonoInput.style.display='block';
  } else {
    loginTitle.textContent='Login'; loginBtn.textContent='Ingresar';
    nombreInput.style.display='none'; telefonoInput.style.display='none';
  }
});

loginBtn.addEventListener('click',()=>{
  if(loginTitle.textContent==='Login'){
    fetch(`https://opensheet.elk.sh/${SHEET_ID}/Usuarios`)
      .then(r=>r.json())
      .then(data=>{
        usersCache=data;
        const user=usersCache.find(u=>u.Usuario===usuarioInput.value && u.Contrase√±a===passwordInput.value);
        if(user){
          if(parseInt(user.Presupuestos || 0) > 3){
            alert("‚ùå Has excedido el l√≠mite de presupuestos. No puedes entrar."); return;
          }
          telefonoUsuario = user.Telefono || ""; // Guardamos tel√©fono
          document.body.classList.add('logged'); mainSection.style.display='flex';
        } else alert('Usuario o contrase√±a incorrectos');
      })
      .catch(err=>{console.error(err); alert('Error al conectar con la base de usuarios');});
  } else {
    if(!usuarioInput.value || !passwordInput.value || !nombreInput.value || !telefonoInput.value){
      alert('Completa todos los campos'); return;
    }
    telefonoUsuario = telefonoInput.value; // guardamos tel√©fono nuevo usuario

    const loader = document.createElement('div');
    loader.textContent = 'Creando usuario...';
    loader.style.position='fixed';
    loader.style.top='50%';
    loader.style.left='50%';
    loader.style.transform='translate(-50%,-50%)';
    loader.style.background='rgba(0,0,0,0.8)';
    loader.style.color='white';
    loader.style.padding='20px';
    loader.style.borderRadius='12px';
    loader.style.zIndex='9999';
    document.body.appendChild(loader);

    const formData=new FormData();
    formData.append('Usuario',usuarioInput.value);
    formData.append('Contrase√±a',passwordInput.value);
    formData.append('Nombre',nombreInput.value);
    formData.append('Telefono',telefonoInput.value);
    fetch(URL_SCRIPT_CREAR_USUARIO,{method:'POST',body:formData})
      .then(r=>r.json())
      .then(res=>{
        loader.remove();
        alert(res.message);
        if(res.success){
          document.body.classList.add('logged'); mainSection.style.display='flex';
          loginTitle.textContent='Login'; loginBtn.textContent='Ingresar';
          nombreInput.style.display='none'; telefonoInput.style.display='none';
        }
      }).catch(()=>{loader.remove(); alert('Error al crear usuario');});
  }
});
</script>
</body>
</html>